# IMPLEMENTATION_REQUIREMENTS.md

## 项目：电子女友（macOS 单机版）— Implementation Requirements v1

> 目标：先做一个 macOS 可玩的“3A质感”单机版本（Vertical Slice），不做 Web 端，不依赖在线服务也能完整游玩核心循环。
> 核心系统以《功德值经济体系 & 运势（气运）系统（v1.0）》为数值基准（见 DESIGN 文档）。

---

## 0. 交付定义（必须明确）
### 0.1 v1 必须可玩的“核心循环”
1. 每日发放功德（Daily），功德可存（Cap）、可透支至 DebtLimit
2. 功德余额映射 LuckScore（LS），并驱动事件好坏概率
3. 事件系统：在线/离线都可触发，但离线不得“猝死删号”
4. 商店：功德支付 + 天机券支付（不可反向兑换）
5. 关键玩法：
   - 推演天机（免费一次 + 递增定价 + 反噬）
   - 遮掩天机（降低围观/抢夺）
   - 护道阵法（玄甲阵等）
   - 锦鲤池抽卡（保底+软保底）
6. 存档/读档稳定：崩溃/断电不损坏存档
7. macOS 本地支付（可先做“调试支付”开关，后续再接 StoreKit/Steam）

### 0.2 v1 非目标（明确不做）
- Web 端/跨端联机/多人交易
- PVP
- 复杂开放世界（可用小地图 + 场景切换 + 关键镜头叙事替代）
- 任何“真实影响现实生活”的承诺（只做叙事层模拟）

---

## 1. 平台与构建要求
### 1.1 平台
- 目标平台：macOS（优先 Apple Silicon）
- 分发方式（先定一个）：
  - A: 独立安装包（自有更新器/手动更新）
  - B: Steam（建议：更容易做支付与更新）
  - C: Mac App Store（会受沙盒/支付规则限制）

> v1 可先走 A 或 B；MAS 放到 v2 评估。

### 1.2 构建与工程规范
- 版本控制：Git + Git LFS（大资源必须进 LFS）
- CI（可选但推荐）：自动打包 nightly build
- 资源命名与目录规范必须固定（否则3A工程会爆炸）

---

## 2. 推荐技术栈（mac 3A优先路线）
### 2.1 引擎（建议）
- Unreal Engine 5.x
  - 逻辑：C++（系统）+ Blueprint（剧情/关卡/交互）
  - UI：UMG/CommonUI
  - 数据：DataTable/DataAsset + 可热更新的 JSON（策划表）

> 若团队更偏应用开发：Unity 亦可，但 v1 必须确保“UI氛围与镜头表现”达到3A质感。

### 2.2 音频与演出
- 音频中间件（可选）：FMOD / Wwise
- 最低要求：事件触发必须有音效反馈（天机/反噬/遮掩/抽卡/护道）

---

## 3. 系统实现要求（硬性）
## 3.1 时间系统（Day & Tick）
- 服务器概念：v1 采用本地“游戏日”定义
- 每小时 Tick 一次事件（或在关键节点强制 Tick）
- 每自然日（本地时区）发放 Daily 功德
- 必须支持“修改系统时间”的防刷策略：
  - 采用单调递增计时 + 校验（至少做到：倒退时间不重复领奖）

## 3.2 功德系统（G）
实现字段：
- G: 当前功德余额（可为负）
- Cap: 功德上限
- Daily: 日发放
- DebtLimit: 透支下限（负数）
- Reserve: 安全储备（锁定，用于离线护道）
- Y: 余庆（溢出缓冲，按设计文档衰减与用途限制）

规则必须与设计文档一致：
- DebtLimit = -Daily
- 达到 DebtLimit 后禁止继续用功德支付（天机券支付不受此限制）
- 余庆仅可用于“守护型消费”，不可用于抽卡

## 3.3 运势系统（LuckScore, LS）
- LS ∈ [-100, +100]
- LS 由 G 映射（正/负分别用非线性曲线）
- 事件概率乘数：
  - GoodMult = 2^(LS/50)
  - BadMult  = 2^(-LS/50)

实现要求：
- 所有“好/坏事件概率”必须通过该乘数统一调制（禁止各系统私自加概率）

## 3.4 天机推演与反噬（R）
- 每日首次推演免费
- 当日多次推演递增定价（按设计文档）
- 每次付费推演累积反噬点 R
- 反噬影响：
  - LS_effective = LS - min(30, 5*R)
  - 并提高“围观/抢夺/偷家”的基准概率（除非遮掩天机）

必须实现“反噬可被清除/缓解”的机制入口（哪怕 v1 只做 1 种清除道具）。

## 3.5 事件系统（在线/离线公平）
事件分级：S0/S1/S2/S3

离线保护硬规则：
1. 离线期间 S3 事件最多触发一次/24h
2. 若触发 S3：
   - 优先消耗 Reserve/余庆/护道道具自动化解并生成战报
   - 若资源不足：降级为“S2濒死”，给玩家 12 小时救援窗口
   - 超过救援窗口才允许进入死亡结算

> 重点：绝不允许玩家一觉醒来“角色没了”。

## 3.6 商店与货币
货币：
- 功德值：硬通货，决定运势
- 天机券：充值货币，可替代功德支付，但不可兑换回功德

结算规则：
- 天机券抵扣功德：按 VIP 汇率（见设计文档）
- 使用天机券支付：不触发功德负债
- 但要有轻微“天道记账”代价（例如：当天推演上限更紧/部分奇遇权重略降）

## 3.7 抽卡（锦鲤池）
- 必须有：
  - 概率表（可配置）
  - 史诗保底、传说保底
  - 软保底曲线
  - 十连规则（必出 ≥ 稀有）
- 抽卡产物必须支持“堆叠/整理策略”（避免背包格子爆炸）
- 扩展背包可商业化，但 v1 必须保证“不买也能玩”（只是更麻烦）

---

## 4. 数据与存档
### 4.1 存档内容
- 玩家状态（G/Cap/Daily/DebtLimit/Reserve/Y/LS/R）
- 角色状态（李清然：境界/修炼进度/伤势/心情/好感/装备/阵法）
- 世界状态（事件冷却/离线战报/关键剧情节点/抽卡保底计数）
- 商店状态（VIP、天机券余额、已购技能、限购）

### 4.2 存档要求
- 原子写入（写临时文件 -> 校验 -> 替换）
- 版本号与迁移（schemaVersion）
- 允许回滚到最近一次成功存档

---

## 5. 演出与“3A质感”最低标准（v1 也必须做到）
- 关键系统交互必须有：
  - 动画（UI动效/镜头轻推拉）
  - 音效
  - 文字风格统一（天道评语/卦象语气一致）
- 三类“爽点”必须有可感知表现：
  1. 抽卡出金（光、音、镜头）
  2. 遮掩天机成功（天地异象被掐灭的反馈）
  3. 护道救援（雷火符/护盾/阵法的强反馈）

---

## 6. 测试与验收（DoD）
### 6.1 功能验收
- 连续 7 天发放功德无重复、无丢失
- 负债触底后功德支付被拒绝，天机券支付仍可用
- 离线 24h：不发生“直接死亡”，必有救援窗口或自动护道
- 抽卡保底可被稳定复现（固定随机种子/测试模式）

### 6.2 性能验收（mac）
- 目标帧率：>= 60（中档机），关键演出不掉到不可接受
- 启动时间与首帧：可量化、可优化（埋点或日志）

---

## 7. 里程碑建议（给 codeX）
- M0：工程骨架 + 存档 + 时间系统
- M1：功德/运势/事件（含离线保护）
- M2：商店（功德/天机券/VIP）+ 抽卡（保底）
- M3：护道/遮掩/推演/反噬闭环
- M4：演出打磨（3A质感最低标准达标）。